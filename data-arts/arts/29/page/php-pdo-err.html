<h3>Описание проблемы</h3>
<p>
    Один из скриптов (problem_script.php), который мне приходилось
    отлаживать, иногда завершался ошибками PDO.
</p>
<p>
    Сначала, при запросах на выборку данных, выбрасывались предупреждения:
</p>
<div class="example">
    PHP Warning:  PDO::query(): MySQL server has gone away in
    problem_script.php.php on line 67<br>
    PDO::query(): Error reading result set's header in problem_script.php on
    line 67<br>
    PHP Warning:  Invalid argument supplied for foreach() in
    problem_script.php on line 67<br>
</div>
<p>
    После следовал запрос на обновление данных и скрипт завершался
    критической ошибкой:
</p>
<div class="example">
    PHP Fatal error:  Call to a member function fetch() on a non-object in
    problem_script.php on line 93
</div>
<p>
    Проблема возникала не каждый раз, со временем стала возникать чаще и
    иногда скрипт не выполнялся даже ночью по cron во время минимальной
    нагрузки.
</p>
<p>
    Первым в скрипте создавалось подключение к MySQL БД, после следовал длительный
    обмен с сервисом 1С и обрабатывался ответ, а затем
    выбирались и обновлялись данные в MySQL базе данных используя PDO. Объем
    передаваемой информации из 1С рос постепенно, ошибки возникали все чаще.
</p>
<h3>Причина</h3>
<p>Причина оказалась не совсем очевидной, но решение было очень простым:
    В настройках mysql есть опции <b>wait_timeout</b> - время в секундах, в течении
    которого mysql серевер ждет действий от неактивных подключений, пока их
    не закроет.
    Время выполнения php скрипта было установлено в 600 сек, а wait_timeout
    = 300 сек. При этом скрипт мог выполнятся и более 5 мин, завершаясь без
    ошибок, если обмен с 1С занимал менее <b>wait_timeout</b>
</p>
<h3>Способ решения</h3>
<p>
    В моем случае мне даже не пришлось ничего настраивать, я просто перенес
    конструкцию
<div class="example">
    $dbh = new PDO($host, $user, $pass);
</div>

    ниже, после блока длительных операции обмена данным с 1C, и ошибки
    прекратились.
</p>
<h3>Выводы:</h3>
<p>
    Далеко не все выбрасываемые ошибки php интуитивно понятны, еще сложнее
    становится когда проблема возникает не каждый раз и зависит от сторонних
    сервисов.
    Надо быть настойчивым и терпеливым чтоб разобрать весь скрипт на кусочки
    и найти закономерности в появлении ошибок.
</p>